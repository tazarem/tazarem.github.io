{
    "version": "https://jsonfeed.org/version/1",
    "title": "Coding Coconut • All posts by \"배포\" category",
    "description": "주니어 웹 프론트엔드/백엔드 개발자. \\n  공부하는 것도, 노는 것도 그만큼 좋아합니다. \\n 현 직장에서는 AWS Lambda 와 Typscript 를 접목한 서드파티 모듈 개발을 하고 있습니다.",
    "home_page_url": "https://coding-coconut.com",
    "items": [
        {
            "id": "https://coding-coconut.com/post/cluwfwnxa000n2j5o2juma63x/",
            "url": "https://coding-coconut.com/post/cluwfwnxa000n2j5o2juma63x/",
            "title": "podman 컨테이너 내부 pm2 강제 종료 현상",
            "date_published": "2023-05-19T07:18:52.000Z",
            "content_html": "<p>podman 컨테이너가 자꾸 강제 종료되길래 컨테이너를 재가동하고 로그를 찍어봤다.</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 컨테이너 가동</span></span><br><span class=\"line\">podman start [컨테이너 명]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 가동중인 컨테이너 확인</span></span><br><span class=\"line\">podman ps</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 컨테이너 내부의 로그를 확인</span></span><br><span class=\"line\">podman <span class=\"built_in\">log</span> [컨테이너 명]</span><br></pre></td></tr></table></figure>\n\n\n<p>콘솔 확인 결과, 아래의 스택오버플로우 포스트처럼 pm2에서 코드 0 으로 종료된다는 문구가 출력됐다.</p>\n<p><a href=\"https://stackoverflow.com/questions/58947629/node-js-pm2-log-app-server0-exited-with-code-0-via-signal-sigkill\">https://stackoverflow.com/questions/58947629/node-js-pm2-log-app-server0-exited-with-code-0-via-signal-sigkill</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[RSS]Time 60min Call Complete.</span><br><span class=\"line\">RSS Timer::60 call complete.</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  generation_event: <span class=\"string\">&#x27;sitemap&#x27;</span>,</span><br><span class=\"line\">  origin_commander: <span class=\"string\">&#x27;timer&#x27;</span>,</span><br><span class=\"line\">  is_timer: 30</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">[Sitemap]Time 30min Call Complete.</span><br><span class=\"line\">Sitemap Timer::30 call complete.</span><br><span class=\"line\">2023-05-18T05:59:41: PM2 <span class=\"built_in\">log</span>: App name:app id:0 disconnected</span><br><span class=\"line\">2023-05-18T05:59:41: PM2 <span class=\"built_in\">log</span>: App [app:0] exited with code [0] via signal [SIGTERM]</span><br><span class=\"line\">2023-05-18T05:59:41: PM2 error: Error caught <span class=\"keyword\">while</span> calling pidusage</span><br><span class=\"line\">2023-05-18T05:59:41: PM2 error: Error: ESRCH: no such process, <span class=\"built_in\">read</span></span><br><span class=\"line\">2023-05-18T05:59:41: PM2 error: Error caught <span class=\"keyword\">while</span> calling pidusage</span><br><span class=\"line\">2023-05-18T05:59:41: PM2 error: Error: ESRCH: no such process, <span class=\"built_in\">read</span></span><br><span class=\"line\">2023-05-18T05:59:41: PM2 error: 0 : id unknown</span><br><span class=\"line\">2023-05-18T05:59:41: PM2 error: Trace: Error: 0 : id unknown</span><br><span class=\"line\">    at God.logAndGenerateError (/usr/<span class=\"built_in\">local</span>/lib/node_modules/pm2/lib/God/Methods.js:39:12)</span><br><span class=\"line\">    at God.stopProcessId (/usr/<span class=\"built_in\">local</span>/lib/node_modules/pm2/lib/God/ActionMethods.js:289:21)</span><br><span class=\"line\">    at God.deleteProcessId (/usr/<span class=\"built_in\">local</span>/lib/node_modules/pm2/lib/God/ActionMethods.js:366:9)</span><br><span class=\"line\">    at Server.onmessage (/usr/<span class=\"built_in\">local</span>/lib/node_modules/pm2/node_modules/pm2-axon-rpc/lib/server.js:104:6)</span><br><span class=\"line\">    at RepSocket.emit (node:events:513:28)</span><br><span class=\"line\">    at RepSocket.emit (node:domain:489:12)</span><br><span class=\"line\">    at Parser.&lt;anonymous&gt; (/usr/<span class=\"built_in\">local</span>/lib/node_modules/pm2/node_modules/pm2-axon/lib/sockets/rep.js:51:15)</span><br><span class=\"line\">    at Parser.emit (node:events:513:28)</span><br><span class=\"line\">    at Parser.emit (node:domain:489:12)</span><br><span class=\"line\">    at Parser._write (/usr/<span class=\"built_in\">local</span>/lib/node_modules/pm2/node_modules/amp/lib/stream.js:91:16)</span><br><span class=\"line\">    at God.logAndGenerateError (/usr/<span class=\"built_in\">local</span>/lib/node_modules/pm2/lib/God/Methods.js:34:15)</span><br><span class=\"line\">    at /usr/<span class=\"built_in\">local</span>/lib/node_modules/pm2/lib/God/ActionMethods.js:367:30</span><br><span class=\"line\">    at God.stopProcessId (/usr/<span class=\"built_in\">local</span>/lib/node_modules/pm2/lib/God/ActionMethods.js:289:14)</span><br><span class=\"line\">    at God.deleteProcessId (/usr/<span class=\"built_in\">local</span>/lib/node_modules/pm2/lib/God/ActionMethods.js:366:9)</span><br><span class=\"line\">    at Server.onmessage (/usr/<span class=\"built_in\">local</span>/lib/node_modules/pm2/node_modules/pm2-axon-rpc/lib/server.js:104:6)</span><br><span class=\"line\">    at RepSocket.emit (node:events:513:28)</span><br><span class=\"line\">    at RepSocket.emit (node:domain:489:12)</span><br><span class=\"line\">    at Parser.&lt;anonymous&gt; (/usr/<span class=\"built_in\">local</span>/lib/node_modules/pm2/node_modules/pm2-axon/lib/sockets/rep.js:51:15)</span><br><span class=\"line\">    at Parser.emit (node:events:513:28)</span><br><span class=\"line\">    at Parser.emit (node:domain:489:12)</span><br><span class=\"line\">2023-05-18T05:59:41: PM2 <span class=\"built_in\">log</span>: PM2 successfully stopped</span><br></pre></td></tr></table></figure>\n\n<p>컨테이너 위에서 돌아가고 있는 프로그램은 Express API 서버였고, 스케쥴러처럼 특정 시간대에 트리거를 하는 로직을 수행하고 있었다.</p>\n<p>동일한 작동 방식으로 짜인 다른 컨테이너도 해당 오류가 일어나지 않았는데 왜 이 컨테이너만 이런 문제가 일어났을까?</p>\n<p>컨테이너의 Express 서버는 AWS의 Lambda를 호출하고 있었는데, 이 Lambda는 파일 생성이라는 다소 무거운 작업을 수행한다.</p>\n<ul>\n<li>axios 요청에서 타임아웃을 내지 않더라도, 요청 시간이 너무 길어지면 프로세스가 죽은 것임으로 간주하고 pm2가 강제 종료를 수행한다.</li>\n</ul>\n<p>해당 내역때문에 lamdba의 헤비한 로직을 비동기로 처리하고, 응답을 먼저 돌려주는 방식으로 바꾸었다.</p>\n",
            "tags": [
                "cluster",
                "podman",
                "pm2",
                "이슈",
                "문제"
            ]
        }
    ]
}